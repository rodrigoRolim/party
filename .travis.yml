sudo: false
language: node_js
node_js: 8.15.1
services:
  - docker
env:
  - SECRET=somesecretkey
cache:
  directories:
    - "node_modules"
before_script:
  - npm update -q
  - npm install

stages:
  - compile
  - tests
  - name: deploy to staging
    if: branch = develop
  - name: test develop
    if: branch = develop
  - name: deploy to production
    if: branch = master
  - name: test production
    if: branch = master

jobs:
  include:
    - stage: tests
      name: "Unit Test"
      script: npm run test:unit
    - script: npm run test:integration
      name: "Integration Test"
    - script: npm run build
      name: build
    - stage: deploy to staging
      script: skip
      deploy: &heroku
        skip_cleanup: true
        provider: heroku
        app: app-party-staging
        api_key: ${api_key}
        on: 
          repo: rodrigoRolim/party
          branch: staging
    - stage: test staging
      script: "curl https://app-party-staging.herokuapp.com"
      
    - stage: deploy to production
      script: /bin/true
      deploy: 
        <<: *heroku
        app: app-party-production
        on: 
          repo: rodrigoRolim/party
          branch: master
    - stage: test production
      script: "curl https://app-party-production.herokuapp.com"